name: Build CCA Lab Artifacts (Remote Source)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake git bison flex bc libssl-dev device-tree-compiler python3 python3-pip wget
          # 安装 Linux GNU 交叉编译器
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Install Arm GNU Toolchain (Bare Metal)
        run: |
          echo "Downloading Arm GNU Toolchain..."
          wget -q https://developer.arm.com/-/media/Files/downloads/gnu/13.2.rel1/binrel/arm-gnu-toolchain-13.2.rel1-x86_64-aarch64-none-elf.tar.xz
          tar -xf arm-gnu-toolchain-13.2.rel1-x86_64-aarch64-none-elf.tar.xz
          echo "$(pwd)/arm-gnu-toolchain-13.2.Rel1-x86_64-aarch64-none-elf/bin" >> $GITHUB_PATH

      - name: Download and Extract Source Code
        run: |
          BASE_URL="https://compass.sustech.edu.cn/cs315/2025Fall/tee-lab"
          mkdir tf-rmm linux-cca trusted-firmware-a kvmtool-cca
          
          wget -q -O tf-rmm.tar.xz "$BASE_URL/tf-rmm.tar.xz"
          tar -xf tf-rmm.tar.xz -C tf-rmm --strip-components=1
          
          wget -q -O linux-cca.tar.xz "$BASE_URL/linux-cca.tar.xz"
          tar -xf linux-cca.tar.xz -C linux-cca --strip-components=1
          
          wget -q -O trusted-firmware-a.tar.xz "$BASE_URL/trusted-firmware-a.tar.xz"
          tar -xf trusted-firmware-a.tar.xz -C trusted-firmware-a --strip-components=1
          
          wget -q -O kvmtool-cca.tar.xz "$BASE_URL/kvmtool-cca.tar.xz"
          tar -xf kvmtool-cca.tar.xz -C kvmtool-cca --strip-components=1

      - name: Build TF-RMM
        run: |
          export CROSS_COMPILE=aarch64-none-elf-
          cd tf-rmm
          rm -rf build
          cmake -DRMM_CONFIG=fvp_defcfg -S . -B build -DLOG_LEVEL=40
          cmake --build build

      - name: Build Linux Kernel
        run: |
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          cd linux-cca
          make defconfig
          make all -j$(nproc)

      - name: Build Trusted Firmware-A (TF-A)
        run: |
          export CROSS_COMPILE=aarch64-none-elf-
          cd trusted-firmware-a
          
          # 修复 GCC 13 兼容性问题
          grep -rl "\-Werror" . | xargs sed -i 's/-Werror/-Wno-error/g'
          grep -rl "\-\-fatal-warnings" . | xargs sed -i 's/--fatal-warnings//g'
          
          make PLAT=fvp clean
          
          make CROSS_COMPILE=aarch64-none-elf- \
          PLAT=fvp \
          CTX_INCLUDE_AARCH32_REGS=0 \
          ENABLE_RME=1 \
          RMM=../tf-rmm/build/rmm.img \
          FVP_HW_CONFIG_DTS=fdts/fvp-base-gicv3-psci.dts \
          DEBUG=0 \
          LOG_LEVEL=20 \
          ARM_LINUX_KERNEL_AS_BL33=1 \
          PRELOADED_BL33_BASE=0x84000000 \
          all fip -j$(nproc)

      - name: Build kvmtool (Fix Deps)
        run: |
          # 1. 下载并编译 libfdt (ARM64 静态库)
          echo "Building libfdt for ARM64..."
          git clone --depth 1 https://git.kernel.org/pub/scm/utils/dtc/dtc.git dtc-src
          cd dtc-src
          
          # 编译静态库 (不再编译 shared library 以免版本号问题)
          make libfdt CC=aarch64-linux-gnu-gcc AR=aarch64-linux-gnu-ar
          
          # === 关键修正：手动创建一个标准的安装目录结构 ===
          mkdir -p ../libfdt-install/include
          mkdir -p ../libfdt-install/lib
          
          # 复制头文件 (kvmtool 需要 libfdt.h)
          cp libfdt/libfdt.h ../libfdt-install/include/
          cp libfdt/fdt.h    ../libfdt-install/include/
          
          # 复制静态库
          cp libfdt/libfdt.a ../libfdt-install/lib/
          cd ..
          
          # 2. 编译 kvmtool
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          cd kvmtool-cca
          
          make clean
          
          # 关键参数修正：
          # LIBFDT_DIR 指向安装根目录
          # CFLAGS 手动指定头文件路径 (双重保险)
          # LDFLAGS 手动指定库文件路径 (双重保险)
          make lkvm-static ARCH=arm64 \
            LIBFDT_DIR=../libfdt-install \
            CFLAGS="-I../libfdt-install/include" \
            LDFLAGS="-L../libfdt-install/lib" \
            -j$(nproc)
          
          ls -lh lkvm-static
          
      - name: Collect Artifacts
        run: |
          mkdir artifacts
          cp tf-rmm/build/rmm.img artifacts/
          cp linux-cca/arch/arm64/boot/Image artifacts/
          cp trusted-firmware-a/build/fvp/release/bl1.bin artifacts/
          cp trusted-firmware-a/build/fvp/release/fip.bin artifacts/
          cp kvmtool-cca/lkvm-static artifacts/
          
          echo "Artifacts collected:"
          ls -lh artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: cca-lab-build-${{ github.run_number }}
          name: CCA Lab Binaries (Build ${{ github.run_number }})
          files: |
            artifacts/rmm.img
            artifacts/Image
            artifacts/bl1.bin
            artifacts/fip.bin
            artifacts/lkvm-static
