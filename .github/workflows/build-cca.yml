name: Build CCA Lab Artifacts (Cached & Fixed)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-final:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake git bison flex bc libssl-dev device-tree-compiler python3 python3-pip wget
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Restore Core Artifacts Cache
        id: cache-core
        uses: actions/cache@v3
        with:
          path: artifacts_core/
          key: cca-lab-core-binaries-v1

      - name: Install Arm GNU Toolchain
        if: steps.cache-core.outputs.cache-hit != 'true'
        run: |
          wget -q https://developer.arm.com/-/media/Files/downloads/gnu/13.2.rel1/binrel/arm-gnu-toolchain-13.2.rel1-x86_64-aarch64-none-elf.tar.xz
          tar -xf arm-gnu-toolchain-13.2.rel1-x86_64-aarch64-none-elf.tar.xz
          echo "$(pwd)/arm-gnu-toolchain-13.2.Rel1-x86_64-aarch64-none-elf/bin" >> $GITHUB_PATH

      - name: Build Core Components
        if: steps.cache-core.outputs.cache-hit != 'true'
        run: |
          BASE_URL="https://compass.sustech.edu.cn/cs315/2025Fall/tee-lab"
          mkdir tf-rmm linux-cca trusted-firmware-a
          
          # 下载
          wget -q -O tf-rmm.tar.xz "$BASE_URL/tf-rmm.tar.xz"
          tar -xf tf-rmm.tar.xz -C tf-rmm --strip-components=1
          wget -q -O linux-cca.tar.xz "$BASE_URL/linux-cca.tar.xz"
          tar -xf linux-cca.tar.xz -C linux-cca --strip-components=1
          wget -q -O trusted-firmware-a.tar.xz "$BASE_URL/trusted-firmware-a.tar.xz"
          tar -xf trusted-firmware-a.tar.xz -C trusted-firmware-a --strip-components=1
          
          # 编译 RMM
          export CROSS_COMPILE=aarch64-none-elf-
          cd tf-rmm
          cmake -DRMM_CONFIG=fvp_defcfg -S . -B build -DLOG_LEVEL=40
          cmake --build build
          cd ..
          
          # 编译 Kernel
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          cd linux-cca
          make defconfig
          make all -j$(nproc)
          cd ..

          # 编译 TF-A
          export CROSS_COMPILE=aarch64-none-elf-
          cd trusted-firmware-a
          grep -rl "\-Werror" . | xargs sed -i 's/-Werror/-Wno-error/g'
          grep -rl "\-\-fatal-warnings" . | xargs sed -i 's/--fatal-warnings//g'
          make PLAT=fvp clean
          make CROSS_COMPILE=aarch64-none-elf- PLAT=fvp CTX_INCLUDE_AARCH32_REGS=0 ENABLE_RME=1 RMM=../tf-rmm/build/rmm.img FVP_HW_CONFIG_DTS=fdts/fvp-base-gicv3-psci.dts DEBUG=0 LOG_LEVEL=20 ARM_LINUX_KERNEL_AS_BL33=1 PRELOADED_BL33_BASE=0x84000000 all fip -j$(nproc)
          cd ..
          
          # 缓存
          mkdir -p artifacts_core
          cp tf-rmm/build/rmm.img artifacts_core/
          cp linux-cca/arch/arm64/boot/Image artifacts_core/
          cp trusted-firmware-a/build/fvp/release/bl1.bin artifacts_core/
          cp trusted-firmware-a/build/fvp/release/fip.bin artifacts_core/

      - name: Build kvmtool (FIXED)
        run: |
          BASE_URL="https://compass.sustech.edu.cn/cs315/2025Fall/tee-lab"
          mkdir kvmtool-cca
          wget -q -O kvmtool-cca.tar.xz "$BASE_URL/kvmtool-cca.tar.xz"
          tar -xf kvmtool-cca.tar.xz -C kvmtool-cca --strip-components=1
          
          # 1. 准备 libfdt (ARM64 静态库)
          git clone --depth 1 https://github.com/dgibson/dtc.git dtc-src
          cd dtc-src
          make libfdt CC=aarch64-linux-gnu-gcc AR=aarch64-linux-gnu-ar
          
          # === 扁平化安装 (符合 kvmtool Makefile 癖好) ===
          mkdir -p ../libfdt-flat
          # 这里的路径是相对于 dtc-src 的
          cp libfdt/libfdt.h ../libfdt-flat/
          cp libfdt/fdt.h    ../libfdt-flat/
          cp libfdt/libfdt_env.h ../libfdt-flat/
          cp libfdt/libfdt.a ../libfdt-flat/
          
          # 获取绝对路径，防止相对路径出问题
          LIBFDT_ABS_PATH=$(readlink -f ../libfdt-flat)
          echo "Libfdt installed at: $LIBFDT_ABS_PATH"
          cd ..
          
          # 2. 编译 kvmtool
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          cd kvmtool-cca
          
          # [修正] 移除 make clean，防止因缺少参数导致的解析错误
          # 如果非要 clean，必须带上参数: make clean LIBFDT_DIR=$LIBFDT_ABS_PATH
          
          # 编译命令
          make lkvm-static ARCH=arm64 LIBFDT_DIR=$LIBFDT_ABS_PATH -j$(nproc)
          
          ls -lh lkvm-static

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: cca-lab-final-${{ github.run_number }}
          name: CCA Lab Binaries (Build ${{ github.run_number }})
          files: |
            artifacts_core/rmm.img
            artifacts_core/Image
            artifacts_core/bl1.bin
            artifacts_core/fip.bin
            kvmtool-cca/lkvm-static
